(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{54:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return b}));var r=n(2),a=n(6),o=(n(0),n(90)),i={id:"quick-start-guide",title:"Quick Start Guide",sidebar_label:"Quick Start Guide",slug:"/"},c={unversionedId:"quick-start-guide",id:"quick-start-guide",isDocsHomePage:!1,title:"Quick Start Guide",description:"Getting your Rails app set up to work with Kuby is pretty straightforward. Here's a quick overview of the necessary steps:",source:"@site/docs/quick_start_guide.md",slug:"/",permalink:"/docs/docs/",editUrl:"https://github.com/getkuby/kuby-docs/edit/master/docs/quick_start_guide.md",version:"current",sidebar_label:"Quick Start Guide",sidebar:"sidebar",previous:{title:"Why Docker and Kubernetes?",permalink:"/docs/docs/why"},next:{title:"After the Deploy",permalink:"/docs/docs/after-the-deploy"}},l=[{value:"Installing Docker",id:"installing-docker",children:[]},{value:"Choosing a Provider",id:"choosing-a-provider",children:[]},{value:"Choosing a Docker Registry",id:"choosing-a-docker-registry",children:[{value:"Docker Hub",id:"docker-hub",children:[]},{value:"Gitlab",id:"gitlab",children:[]}]},{value:"Adding Kuby to your Bundle",id:"adding-kuby-to-your-bundle",children:[]},{value:"Configuring Kuby",id:"configuring-kuby",children:[{value:"Deploy Environments",id:"deploy-environments",children:[]},{value:"Configuring Docker",id:"configuring-docker",children:[]},{value:"Configuring Kubernetes",id:"configuring-kubernetes",children:[]}]},{value:"Deploying",id:"deploying",children:[]}],s={rightToc:l};function b(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Getting your Rails app set up to work with Kuby is pretty straightforward. Here's a quick overview of the necessary steps:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Install Docker"),Object(o.b)("li",{parentName:"ol"},"Choose a hosting provider"),Object(o.b)("li",{parentName:"ol"},"Choose a Docker registry"),Object(o.b)("li",{parentName:"ol"},"Add the Kuby gems to your bundle"),Object(o.b)("li",{parentName:"ol"},"Configure Kuby"),Object(o.b)("li",{parentName:"ol"},"Deploy!")),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"NOTE"),": Kuby is designed to work with Rails 5.1 and up."),Object(o.b)("h2",{id:"installing-docker"},"Installing Docker"),Object(o.b)("p",null,"The easiest way to install Docker for MacOS and Windows is via ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.docker.com/products/docker-desktop"}),"Docker Desktop"),". You will need Docker to build and push the Docker image for your application (described below)."),Object(o.b)("h2",{id:"choosing-a-provider"},"Choosing a Provider"),Object(o.b)("p",null,"The first step in deploying your app is to choose a hosting provider. At the time of this writing, Kuby supports ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/getkuby/kuby-digitalocean"}),"DigitalOcean"),", ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/getkuby/kuby-linode"}),"Linode"),", ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/getkuby/kuby-azure"}),"Azure"),", and Amazon's ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/getkuby/kuby-eks"}),"EKS"),". Use your provider's dashboard to spin up a Kubernetes cluster. In most cases, this shouldn't involve more than a few button clicks, although for more customizable providers like EKS and Azure you might want to look for specific guides online."),Object(o.b)("h2",{id:"choosing-a-docker-registry"},"Choosing a Docker Registry"),Object(o.b)("p",null,"Kuby uses Docker to package up your application into a Docker ",Object(o.b)("em",{parentName:"p"},"image"),'. Images are then pushed (i.e. uploaded) to something called a "registry." Registries host Docker images so they can be pulled (i.e. downloaded) by the servers that will eventually run them.'),Object(o.b)("h3",{id:"docker-hub"},"Docker Hub"),Object(o.b)("p",null,"There are a number of Docker registries available, some free and some paid. Docker's own offering is called ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://hub.docker.com/"}),"Docker Hub"),", the de-facto registry for open-source projects and commercial solutions alike. Images hosted on Docker Hub are referred to using an abbreviated URL without a hostname, i.e. ",Object(o.b)("inlineCode",{parentName:"p"},"<username>/<repo>"),". If you see an image referred to like this, it means it's hosted on Docker Hub."),Object(o.b)("h3",{id:"gitlab"},"Gitlab"),Object(o.b)("p",null,"Gitlab's Docker registry is a great alternative to Docker Hub. It's free and unlimited. Oh, and a quick note: you don't have to host your code on Gitlab to take advantage of the registry, but they're great for that too."),Object(o.b)("p",null,"Images hosted on 3rd-party registries (i.e. not on Docker Hub) are referred to by their full URL. If you choose to use Gitlab's Docker registry, the URL to your Docker image will look like this:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"https://registry.gitlab.com/<username>/<repo>\n")),Object(o.b)("h2",{id:"adding-kuby-to-your-bundle"},"Adding Kuby to your Bundle"),Object(o.b)("p",null,"Add the kuby-core gem and the corresponding gem for your chosen provider to your Rails application's Gemfile, for example:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"gem 'kuby-core', '< 1.0'\ngem 'kuby-digitalocean', '< 1.0'\n")),Object(o.b)("p",null,"Run ",Object(o.b)("inlineCode",{parentName:"p"},"bundle install")," to install the gems."),Object(o.b)("h2",{id:"configuring-kuby"},"Configuring Kuby"),Object(o.b)("p",null,"Kuby configuration is done via a ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Domain-specific_language"}),"DSL"),". There are two main sections, one for Docker and one for Kubernetes. Put the config into a file called kuby.rb in the root directory of your Rails app."),Object(o.b)("p",null,"Here's what a complete config looks like:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"require 'active_support/core_ext'\nrequire 'active_support/encrypted_configuration'\n\nKuby.define('my-app') do\n  app_creds = ActiveSupport::EncryptedConfiguration.new(\n    config_path: File.join('config', 'credentials.yml.enc'),\n    key_path: File.join('config', 'master.key'),\n    env_key: 'RAILS_MASTER_KEY',\n    raise_if_missing_key: true\n  )\n\n  environment(:production) do\n    docker do\n      credentials do\n        username app_creds[:DOCKER_USERNAME]\n        password app_creds[:DOCKER_PASSWORD]\n        email app_creds[:DOCKER_EMAIL]\n      end\n\n      image_url 'registry.gitlab.com/username/repo'\n    end\n\n    kubernetes do\n      provider :digitalocean do\n        access_token app_creds[:DIGITALOCEAN_ACCESS_TOKEN]\n        cluster_id 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'\n      end\n\n      add_plugin :rails_app do\n        hostname 'mywebsite.com'\n\n        database do\n          user app_creds[:DB_USER]\n          password app_creds[:DB_PASSWORD]\n        end\n      end\n    end\n  end\nend\n")),Object(o.b)("p",null,"Create a Rails initializer at config/initializers/kuby.rb that loads your Kuby config:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"require 'kuby'\nKuby.load!\n")),Object(o.b)("p",null,"Let's go over this config in detail."),Object(o.b)("h3",{id:"deploy-environments"},"Deploy Environments"),Object(o.b)("p",null,"The first line tells Kuby what you want to call your app:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"Kuby.define('my-app')\n")),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"NOTE"),": The next block loads your Rails credentials file. Since your Rails environment may or may not be loaded when your Kuby config loads, we have to access Rails credentials manually."),Object(o.b)("p",null,"The second line defines the ",Object(o.b)("em",{parentName:"p"},"deploy environment"),":"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"environment(:production)\n")),Object(o.b)("p",null,'Deploy environments usually closely mirror your Rails environments. For example, you might create a new Rails environment called "staging" or "preprod" that\'s used to test production changes before they go live.'),Object(o.b)("p",null,'If you\'re a small shop or hobbyist though, chances are the "production" deploy environment is all you need.'),Object(o.b)("h3",{id:"configuring-docker"},"Configuring Docker"),Object(o.b)("p",null,'Kuby can automatically "dockerize" your application. You just need to tell it where to push images and provide some credentials:'),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"docker do\n  credentials do\n    username app_creds[:DOCKER_USERNAME]\n    password app_creds[:DOCKER_PASSWORD]\n    email app_creds[:DOCKER_EMAIL]\n  end\n\n  image_url 'registry.gitlab.com/username/repo'\nend\n")),Object(o.b)("p",null,"The username, password, and email fields are used to authenticate with the Docker registry that hosts your images. For Gitlab, you'll need to create a ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html"}),"personal access token")," instead of your password. The ",Object(o.b)("inlineCode",{parentName:"p"},"image_url")," field is the full URL to your image, including the registry's domain."),Object(o.b)("p",null,"In the example above, the username, password, and email are all provided as environment variables. It's important to remember to ",Object(o.b)("strong",{parentName:"p"},"NEVER")," hard-code sensitive information (like passwords) in your Kuby config or check it into source control (i.e. git). Consider using a tool like ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/bkeepers/dotenv"}),"dotenv")," to automatically load the variables from a file when your app starts (NOTE: don't check the .env file into git either!) or pull credentials straight from ",Object(o.b)("inlineCode",{parentName:"p"},"Rails.application.credentials"),"."),Object(o.b)("h3",{id:"configuring-kubernetes"},"Configuring Kubernetes"),Object(o.b)("p",null,"Now that your app can be packaged up into a Docker image, it's time to use Kubernetes to run it. There are two top-level concerns in the Kubernetes section of your Kuby config: providers and plugins."),Object(o.b)("h4",{id:"providers"},"Providers"),Object(o.b)("p",null,"Each Kubernetes definition must have a provider configured. Providers correspond to the hosting provider you chose earlier. For example, you'll need to add the ",Object(o.b)("inlineCode",{parentName:"p"},":digitalocean")," provider to deploy to a managed DigitalOcean Kubernetes cluster."),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"kubernetes do\n  provider :digitalocean do\n    access_token app_creds[:DIGITALOCEAN_ACCESS_TOKEN]\n    cluster_id 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'\n  end\nend\n")),Object(o.b)("p",null,"Kuby providers are distributed as individual rubygems. Add the one you need to your Gemfile, for example:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"gem 'kuby-digitalocean', '< 1.0'\n")),Object(o.b)("p",null,"Providers can have different config options, so make sure you consult the gem's README for the provider you've chosen."),Object(o.b)("h4",{id:"plugins"},"Plugins"),Object(o.b)("p",null,"Nearly all Kuby's functionality is provided via plugins. For example, simply add the ",Object(o.b)("inlineCode",{parentName:"p"},":rails_app")," plugin to get your Rails app ready to deploy:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"add_plugin :rails_app\n")),Object(o.b)("p",null,"To indicate your app exists behind a particular domain name, specify the ",Object(o.b)("inlineCode",{parentName:"p"},"hostname")," option:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"add_plugin :rails_app do\n  hostname 'mywebsite.com'\nend\n")),Object(o.b)("p",null,"Configuring DNS to point to your Kubernetes cluster is outside the scope of this guide, but all the hosting providers should have tutorials readily available. For example, ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.digitalocean.com/community/tutorials/how-to-point-to-digitalocean-nameservers-from-common-domain-registrars"}),"here's the one")," from DigitalOcean."),Object(o.b)("p",null,"Finally, specify your database credentials:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ruby"}),"add_plugin(:rails_app) do\n  hostname 'mywebsite.com'\n\n  database do\n    user app_creds[:DB_USER]\n    password app_creds[:DB_PASSWORD]\n  end\nend\n")),Object(o.b)("h2",{id:"deploying"},"Deploying"),Object(o.b)("p",null,"Now that Kuby is configured and your Kubernetes cluster is ready, it's time to deploy!"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Build the Docker image"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-sh"}),"bundle exec kuby -e production build\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Push the Docker image to the container registry"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-sh"}),"bundle exec kuby -e production push\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Set up your provider"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-sh"}),"bundle exec kuby -e production setup\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Deploy!"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-sh"}),"RAILS_MASTER_KEY=<your master key> bundle exec kuby -e production deploy\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Rejoice"))))}b.isMDXComponent=!0},90:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=a.a.createContext({}),b=function(e){var t=a.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},u=function(e){var t=b(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=b(n),d=r,m=u["".concat(i,".").concat(d)]||u[d]||p[d]||o;return n?a.a.createElement(m,c(c({ref:t},s),{},{components:n})):a.a.createElement(m,c({ref:t},s))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,i[1]=c;for(var s=2;s<o;s++)i[s]=n[s];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);